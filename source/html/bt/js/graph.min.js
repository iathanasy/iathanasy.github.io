Ext.define("MJ.Graph.Layout",{statics:{BG_FILL:"white",NODE_FILL:"#f92672",NODE_STROKE:"#424242",TEXT_FILL:"white",LINK_STROKE:"#424242",ARROW_FILL:"yellow",FONT_SIZE:20,FONT_FAMILY:"Consolas, Menlo, Monaco, monospace, serif"},config:{width:0,height:0,$paper:null},constructor:function(a){this.initConfig(a)},display:function(){this.$paper.find("svg").empty();var e=this.buildCells_();if(!e){return this}var c=40;var b=Math.max(500,this.width)+c;var g=Math.max(400,this.height)+c;var f=new joint.dia.Graph;var h=new joint.dia.Paper({el:this.$paper,width:b,height:g,model:f,drawGrid:true,gridSize:10,background:{color:MJ.Graph.Layout.BG_FILL}});var d=(b-this.width)>>1;var a=(g-this.height)>>1;h.translate(d,a);f.addCells(e);return this},buildCells_:function(){},createRect_:function(c,a){var b=new joint.shapes.standard.Rectangle();b.position(c.x,c.y);b.resize(c.width,c.height);a=a||{body:{fill:MJ.Graph.Layout.NODE_FILL,stroke:MJ.Graph.Layout.NODE_STROKE},label:{text:c.text,fill:MJ.Graph.Layout.TEXT_FILL,fontSize:MJ.Graph.Layout.FONT_SIZE,fontFamily:MJ.Graph.Layout.FONT_FAMILY}};b.attr(a);c.cell=b;return b},createLink_:function(e,c,b,f,a){var d=new joint.shapes.standard.Link();a=a||{line:{stroke:MJ.Graph.Layout.LINK_STROKE,targetMarker:{fill:MJ.Graph.Layout.ARROW_FILL}}};d.attr(a);d.source(e,{anchor:{name:c}});d.target(b,{anchor:{name:f}});return d}});Ext.define("MJ.Graph.Node",{config:{x:0,y:0,width:0,height:0,text:null,cell:null},constructor:function(a){this.initConfig(a)}});Ext.define("MJ.BinaryTree.GraphLayout",{extend:"MJ.Graph.Layout",statics:{X_SPACE:10,Y_SPACE:30,LINK_TYPE_ELBOW:"elbow",LINK_TYPE_LINE:"line"},config:{tree:null,root:null,nodes:null,maxWidth:0,minX:0,linkType:null},constructor:function(a){this.callParent(arguments);this.initConfig(a)},buildCells_:function(){var c=[];var a=this._buildNodes();for(var b in a){this._buildCell(c,a[b])}return c},_buildCell:function(a,e){var d=this.createRect_(e);if(e.btNode.$className==="MJ.RBTree.Node"){if(e.btNode.color===MJ.RBTree.BLACK){d.attr("body/fill","#000");d.attr("body/stroke","#000")}else{d.attr("body/fill","#f00");d.attr("body/stroke","#f00")}}a.push(d);if(!e.parent){return}var b="left";if(e===e.parent.right){b="right"}var c=this.createLink_(e.parent.cell,b,d,"top");if(!this.linkType||this.linkType===MJ.BinaryTree.GraphLayout.LINK_TYPE_ELBOW){c.router("orthogonal",{padding:3});c.connector("jumpover")}a.push(c)},_buildNodes:function(){var c=this.tree?this.tree.getRoot():null;if(!c){return null}this.root=new MJ.BinaryTree.GraphNode({text:this.tree.getString(c),btNode:c});this.nodes=[];this._fillNodes();this._placeNodes();this._compressNodes();this._measureNodes();var a=[];for(var f in this.nodes){var e=this.nodes[f];for(var b in e){var d=e[b];d.x-=this.minX;a.push(d)}}return this.nodes=a},_addNode:function(a,c){var b=null;if(c){b=new MJ.BinaryTree.GraphNode({text:this.tree.getString(c),btNode:c});a.push(b);this.maxWidth=Math.max(this.maxWidth,b.width)}else{a.push(null)}return b},_fillNodes:function(){var h=[];h.push(this.root);this.nodes.push(h);while(true){var a=this.nodes[this.nodes.length-1];var g=[];var d=false;for(var b in a){var e=a[b];if(e){var f=this._addNode(g,this.tree.getLeft(e.btNode));if(f){e.left=f;f.parent=e;f.level=e.level+1;d=true}var c=this._addNode(g,this.tree.getRight(e.btNode));if(c){e.right=c;c.parent=e;c.level=e.level+1;d=true}}else{g.push(null);g.push(null)}}if(!d){break}this.nodes.push(g)}},_placeNodes:function(){var n=this.nodes.length;var k=[];var q=MJ.textSize(MJ.Graph.Layout.FONT_SIZE+"px",MJ.Graph.Layout.FONT_FAMILY,"6哈j]】").height;var c=this.nodes[n-1].length;var o=this.maxWidth;var m=c*this.maxWidth+o*(c-1);for(var l=0;l<n;l++){var f=this.nodes[l];var b=[];k.push(b);var d=f.length;var a=m-(d-1)*o;var p=a/d-this.maxWidth;p>>=1;var g=0;for(var h=0;h<d;h++){if(h!==0){g+=o}g+=p;var e=f[h];if(e){e.x=g;e.height=q;e.y=l*(q+MJ.BinaryTree.GraphLayout.Y_SPACE);b.push(e)}g+=this.maxWidth;g+=p}}this.nodes=k},_compressNodes:function(){var k=this.nodes.length;if(k<2){return}for(var f=k-2;f>=0;f--){var c=this.nodes[f];for(var h in c){var e=c[h];var d=e.left;var l=e.right;if(!d&&!l){continue}if(d&&l){e.balance(d,l);var j=e.leftBoundEmptyLength();var b=e.rightBoundEmptyLength();var g=Math.min(j,b);g=Math.min(g,(l.x-d.rightX())>>1);var a=d.minLevelSpaceToRight(l)-MJ.BinaryTree.GraphLayout.X_SPACE;a=Math.min(a>>1,g);if(a>0){d.translateX(a);l.translateX(-a)}a=d.minLevelSpaceToRight(l)-MJ.BinaryTree.GraphLayout.X_SPACE;if(a<1){continue}j=e.leftBoundEmptyLength();b=e.rightBoundEmptyLength();if(j<1&&b<1){continue}if(j>b){d.translateX(Math.min(j,a))}else{l.translateX(-Math.min(b,a))}}else{if(d){d.translateX(e.leftBoundEmptyLength())}else{l.translateX(-e.rightBoundEmptyLength())}}}}},_measureNodes:function(){this.minX=this.root.x;var c=0;var f=0;for(var e in this.nodes){var d=this.nodes[e];for(var a in d){var b=d[a];this.minX=Math.min(this.minX,b.x);c=Math.max(c,b.rightX());f=Math.max(f,b.y+b.height)}}this.width=c-this.minX;this.height=f}});Ext.define("MJ.BinaryTree.GraphNode",{extend:"MJ.Graph.Node",statics:{LINE_WIDTH:30},config:{left:null,right:null,parent:null,level:0,btNode:null,treeHeight:0},constructor:function(a){this.callParent(arguments);this.initConfig(a)},getTreeHeight:function(){if(this.treeHeight>0){return this.treeHeight}this.treeHeight=this._getTreeHeight(this);return this.treeHeight},_getTreeHeight:function(a){if(!a){return 0}var c=this._getTreeHeight(a.left);var b=this._getTreeHeight(a.right);var d=1+Math.max(c,b);return a.treeHeight=d},minLevelSpaceToRight:function(c){var a=Math.min(this.getTreeHeight(),c.getTreeHeight());var e=Number.MAX_VALUE;for(var b=0;b<a;b++){var d=c.levelInfo(b).leftX-this.levelInfo(b).rightX;e=Math.min(e,d)}return e},levelInfo:function(g){if(g<0){return null}if(g>=this.getTreeHeight()){return null}var f=[];var b=[];b.push(this);var a=this.level+g;while(b.length>0){var e=b.shift();if(a===e.level){f.push(e)}else{if(e.level>a){break}}if(e.left){b.push(e.left)}if(e.right){b.push(e.right)}}var d=f[0].leftBound();var c=f[f.length-1].rightBound();return{leftX:d,rightX:c}},topLineX:function(){var a=this.width;if(a%2===0){a--}a>>=1;if(this.parent&&this===this.parent.left){return this.rightX()-1-a}else{return this.x+a}},leftBoundLength:function(){return this.x-this.leftBound()},rightBoundLength:function(){return this.rightBound()-this.rightX()},leftBoundEmptyLength:function(){return this.leftBoundLength()-1-MJ.BinaryTree.GraphNode.LINE_WIDTH},rightBoundEmptyLength:function(){return this.rightBoundLength()-1-MJ.BinaryTree.GraphNode.LINE_WIDTH},rightBound:function(){if(!this.right){return this.rightX()}return this.right.topLineX()+1+MJ.BinaryTree.GraphLayout.X_SPACE},leftBound:function(){if(!this.left){return this.x}return this.left.topLineX()-MJ.BinaryTree.GraphLayout.X_SPACE},balance:function(f,d){if(!f||!d){return}var a=this.x-f.rightX();var e=d.x-this.rightX();var g=Math.max(a,e);var b=this.rightX()+g;d.translateX(b-d.x);var c=this.x-g-f.width;f.translateX(c-f.x)},translateX:function(a){if(a===0){return}this.x+=a;if(this.left){this.left.translateX(a)}if(this.right){this.right.translateX(a)}},rightX:function(){return this.x+this.width},setParent:function(a){this.callParent(arguments);this.level=a.level+1},setText:function(b){this.callParent(arguments);var a=MJ.textSize(MJ.Graph.Layout.FONT_SIZE+"px",MJ.Graph.Layout.FONT_FAMILY,b);this.width=a.width+15}});